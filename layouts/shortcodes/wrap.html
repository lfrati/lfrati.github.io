{{- $raw := or (.Get "src") (.Get 0) -}}
{{- if not $raw -}}
  {{- errorf "wrap shortcode requires a 'src' parameter" -}}
{{- end -}}
{{- $src := strings.TrimSpace $raw -}}
{{- $caption := .Get "caption" -}}

{{- $alt := "" -}}
{{- with .Get "alt" -}}
  {{- $alt = . -}}
{{- else -}}
  {{- if $caption -}}
    {{- $alt = $caption -}}
  {{- end -}}
{{- end -}}

{{- $width := "" -}}
{{- with strings.TrimSpace (default "" (.Get "width")) }}
  {{- $val := . -}}
  {{- if findRE "^[0-9]+$" $val }}
    {{- $val = printf "%spx" $val -}}
  {{- end }}
  {{- $width = printf "--wrap-width: %s;" $val -}}
{{- end -}}

{{- $img := .Page.Resources.GetMatch $src -}}
{{- if not $img -}}
  {{- errorf "wrap shortcode: image %q not found for page %s" $src .Page.Path -}}
{{- end -}}

<img src="{{ $img.RelPermalink }}" alt="{{ $alt | htmlEscape }}" loading="lazy" decoding="async" width="{{ $img.Width }}" height="{{ $img.Height }}" class="wrap-figure" {{ with $width }}style="{{ . | safeCSS }}"{{ end }} />{{- if $caption }}<span class="wrap-caption">{{ $caption }}</span>{{- end -}}
