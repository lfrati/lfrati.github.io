{{ define "main" }}
  {{ $dateMachine := .Date | time.Format "2006-01-02T15:04:05-07:00" }}
  {{ $dateHuman := .Date | time.Format ":date_long" }}

  <article class="post">

    <header class="post-header">
      <h1 class="post-title">{{ .Title }}</h1>
      <time datetime="{{ $dateMachine }}">{{ $dateHuman }}</time>
    </header>

    <div class="post-content">
    {{/* Precompute TOC items and share ids with render hooks via Scratch */}}
    {{ $h1s := partial "toc-h1-extract.html" . }}
    {{ .Scratch.Set "tocwrap_ids" (slice) }}
    {{ range $h1s }}
      {{ $.Scratch.Add "tocwrap_ids" (slice .id) }}
    {{ end }}
    {{ .Scratch.Set "tocwrap_open" false }}
    {{ .Scratch.Set "tocwrap_index" -1 }}
    {{ .Scratch.Set "tocwrap_init" true }}

    {{ .Content }}

    {{/* Close any open section wrapper after content render */}}
    {{ partial "toc-close-section.html" . }}
    </div>

  </article>

  {{ if .TableOfContents }}
  
  {{ if gt (len $h1s) 0 }}
  <!-- Table of Contents Component with pre-generated data -->
  <button class="toc-button" id="tocButton" aria-label="Table of Contents">
    <div class="toc-lines" id="tocLines">
      {{ range $index, $h1 := $h1s }}
        <div class="line{{ if eq $index 0 }} active{{ end }}" data-section="{{ $index }}"></div>
      {{ end }}
    </div>
  </button>

  <!-- Expandable TOC pane -->
  <div class="toc-pane" id="tocPane">
    <h3>Table of Contents</h3>
    <div id="tocItems">
      {{ range $index, $h1 := $h1s }}
        <a href="#{{ .id }}" class="toc-item{{ if eq $index 0 }} active{{ end }}" data-section="{{ $index }}" data-target="{{ .id }}">{{ .text }}</a>
      {{ end }}
    </div>
  </div>
  {{ end }}
  {{ end }}

{{ end }}
